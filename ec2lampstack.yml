AWSTemplateFormatVersion: '2010-09-09'
Description: LAMP Stack on EC2 Instance

Parameters:
  InstanceType:
    Type: String
    Description: EC2 Instance type
    Default: t2.micro
  DBPassword:
    Type: String
    NoEcho: true
    Description: MySQL database password

Resources:
  MySecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Allow SSH and HTTP access
      SecurityGroupIngress:
      - FromPort: 22
        ToPort: 22
        Protocol: tcp
        CidrIp: 123.45.67.89/32  # Your IP address
      - FromPort: 80
        ToPort: 80
        Protocol: tcp
        CidrIp: 0.0.0.0/0  # Allow all for now (change later!)

  LampInstance:
    Type: AWS::EC2::Instance
    Properties:
      ImageId: ami-09eb2ed0e9c2f6126  # Amazon Linux 2 AMI
      InstanceType: !Ref InstanceType
      SecurityGroupIds:
        - !Ref MySecurityGroup
      KeyName: brykey2024  # Your key pair name
      UserData:
        Fn::Base64:
          !Sub |
            #!/bin/bash
            yum update -y
            yum install -y httpd mysql php php-mysqlnd
            echo "CREATE DATABASE my_database;" | mysql -u root -p${DBPassword}
            systemctl start httpd
            systemctl enable httpd